---
title: "Домашнее задание 1"
author: "Ластовецкий Дмитрий"
output:
  html_document:
    df_print: paged
---



```{r, echo=FALSE, include=FALSE}
library(haven)
library(plm)
library(ggplot2)
library(dplyr)
library(lmtest)
library(sandwich)
df1<-read_dta(file.choose())
df1 <- na.omit(df1)
```

# Задание 1

```{r}
head(df1)
pooled <- plm(lncrime ~ lnpolice + lndensity + nonwhite, 
              data=df1, model = "pooling")
summary(pooled)
```
1.1. Среднее значение логарифма числа преступлений на человека при равенстве прочих предикторов нулю равно -3.346502 без учета структуры данных. 
При росте натурального логарифма числа полицейских на душу населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.137782 при прочих равных без учета панельной структуры данных. 
При росте натурального логарифма плотности населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.485777 при прочих равных без учета панельной структуры данных.
При росте натурального логарифма небелого населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.219439 при прочих равных без учета панельной структуры данных.
Направление связи между откликом и предикторами мы предварительно можем оценить как положительное. 

1.2. Оценка данных без учета панельной структуре ведёт к aggregation bias - (тенденция, найденная нами на всём массиве может очень плохо работать на отдельных частях выборки), неустойчивости оценок и к ложной значимости оценок из-за заниженных стандартных ошибок.  

# Задание 2. 

```{r}
LSDV <- lm(lncrime ~ lnpolice + lndensity + nonwhite + factor(county), data=df1)
summary(LSDV)
```
Мы получили изменение оценок коэффициентов при предикторах, учли панельную структуру данных, выявили различия между стартовыми условиями в разных округах. Мы избавились от ложной значимости коэффициентов при предикторах. Оценка коэффициента при логарифме плотности населения статистически не значима (значение пи-вэлью 0,81)

В среднем логарифм числа преступлений на человека в 193 округе штата на 0.255073 больше чем в 1 округе при прочих равных. 
В среднем логарифм числа преступлений на человека в 189 округе штата на 1.144283 больше чем в 1 округе при прочих равных. 
В среднем логарифм числа преступлений на человека в 183 округе штата на 0.327500 больше чем в 1 округе при прочих равных. 

# Задание 3

```{r}
fe <- plm(lncrime ~ lnpolice + nonwhite + lndensity , data = df1, index=c("county", "year"), model="within")
summary(fe)
```

3.1. В полученной модели предикторами являются отклонения значений изначальных предикторов от среднего по каждому округу, откликом - отклонения изначального отклика от среднего по округу. В полученной модели оценка коэффициента при предикторе логарифма плотности населения округа статистически не значима (пи-вэлью равно 0.8111) и равна -0.05 как и в модели без внутригруппового преобразования, оценка коэффициента при логарифме числа полицейских на душу населения статистически значима и равна 0.21 (и не изменилась при внутригрупповом преобразовании). Константа отсутствует, так как она сокращается при внутригрупповом преобразовании. Предиктор nonwhite отсутствует, так как он не изменяется с течением времени. 

3.2. Модель не позволяет оценить отсутствие временной динамики у переменной nonwhite. Мы можем считать это недостатком целого ряда моделей для панельных данных, так как мы теряем переменную, которая объясняет часть вариации отклика. 

# Задание 4

```{r}
ols <- plm(lncrime~lnpolice + lndensity + nonwhite, data=df1, model="pooling")
summary(ols)
pFtest(fe, ols)
```

$H_0 : \gamma_0 = ... = \gamma_{n-1} = 0 $


$H_1: \exists i\in[1, n-1]: \gamma_i \neq 0 $

Нулевая гипотеза о равенстве коэффициентов при дамми нулю отвергается на 5-процентном уровне значимости, следовательно, мы можем отдать предпочтение модели с фиксированными эффектами. 

# Задание 5


```{r}
plmtest(ols, type=c("bp"))
```

5.1. $H_0: Var(\alpha_i) = 0$

$H_1: Var(\alpha_i) \neq 0$

H_0 отвергается на пятипроцентном уровне значимости (p-value < 2.2e-16). 

Предпочтение стоит предварительно отдать RE-модели, так как дисперсия случайных эффектов статистически значима. 

5.2. 

```{r}
re <- plm(lncrime~lnpolice + lndensity + nonwhite, data=df1, index=c("county", "year"), model="random")
summary(re)
```
Среднее значение логарифма числа преступлений на человека при равенстве прочих предикторов нулю равно -2.968312.
При росте натурального логарифма числа полицейских на душу населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.197241 при прочих равных.  
При росте натурального логарифма плотности населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.464491 при прочих равных. 
При росте натурального логарифма небелого населения на 1 натуральный логарифм числа преступлений на человека растёт в среднем на 0.221979 при прочих равных. 

RE-модель предполагает изменение значимости коэффициентов при предикторах, изменение значений коэффициентов и даже изменение направления связи (у предиктора плотности населения). 

Главное допущение это $cor(x_{it}, \alpha_i)$. Это допущение слишком мощное по отношению к нашим данным: логарифм количества полицейских на человека может коррелировать с экономической развитостью округа и этническим составом мигрантов округа и т.д. Логарифм плотности населения зависит от типа застройки. 

```{r}
phtest(fe, re)
```
Так как значение пи-вэлъю меньше пяти процентов (0.0402), т.е. различия между оценками не являются систематическими и мы не можем отдавать предпочтения строго одной из моделей. 

Тест Хаусмана ограничен, так как плохо улавливает разницу между низкой корреляцией и отсутствием корреляции, а также содержательно беден - аналогичные выводы можно получить по структуре данных. 

# Задание 6

```{r}
fe_time <- plm(data = df1, lncrime ~ lnpolice + lndensity + nonwhite, index=c("county", "year"), effect = "time",  model = "within")
summary(fe_time)

fe_twoways <- plm(data = df1, lncrime ~ lnpolice + lndensity + nonwhite, index=c("county", "year"), effect = "twoways", model = "within")
summary(fe_twoways)
```

В модели с фиксированными эффектами на время оценки коэффициентов характеризуют средние изменения отклика при увеличении предикторов на единицу при прочих равных в *пространственной* перспективе. В модели с фиксированными эффектами на время и пространство оценки коэффициентов характеризуют средние изменения отклика при увеличении предиктора на единицу в *пространственной и временной перспективе* при прочих равных. 

Содержательно более адекватна модель с фиксированными эффектами на время, так как tricky model носит крайне описательный характер, а модель с фиксированными эффектами на пространство страдает от маленькой выборки по времени (у нас всего 6 периодов, временная динамика сложно прослеживается на основе шести наблюдений)

```{r}
coeftest(fe_time, vcov = vcovHC, type = "HC3")
```
С точностью до сотых оценки коэффициентов не изменились, но у нас есть основания сомневаться в значимости оценки коэффициента при lnpolice (p-value 0.3834). Возможно, что существует гетероскедастичность у данного предиктора. 

# Задание 7

```{r}
y_pred <- fitted(fe_time)
df2<- data.frame(df1, y_pred) 
merged <- df2 %>% group_by(county)%>% summarize(., cor(lncrime, y_pred))%>% merge(df2, ., by="county")
merged$new <- ifelse(abs(merged$`cor(lncrime, y_pred)`)<0.3,1,0)
fe_2time <- plm(lncrime~lnpolice + lndensity + nonwhite, merged[merged$new == 0,], index=c("county", "year"), effect = "time")
coeftest(fe_2time, vcov = vcovHC, type = "HC3")
```

Оценки коэффициентов не изменились с точностью до десятых, значимость также практически не изменилась, однако, у нас всё ещё есть основания сомневаться в значимости оценки коэффициента при lnpolice (p-value 0.51)